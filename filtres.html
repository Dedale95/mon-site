<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recherche avanc√©e - Job Tracker Finance</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.css" />
    
    <style>
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 10000;
        }
        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.8rem;
            font-weight: 700;
        }
        nav a {
            color: white;
            text-decoration: none;
            margin-left: 2rem;
            font-weight: 500;
            transition: opacity 0.3s;
        }
        nav a:hover {
            opacity: 0.8;
        }

        :root {
            --bg: #0b1220;
            --surface: #0f172a;
            --text: #e5e7eb;
            --text-strong: #f8fafc;
            --muted: #cbd5e1;
            --brand-1: #667eea;
            --brand-2: #7c3aed;
            --filter-bg: #0b1b3a; /* dark navy */
            --filter-border: rgba(59,130,246,0.18);
            --label-hover: rgba(59,130,246,0.12);
            --card: #0b1220;
            --card-border: rgba(255,255,255,0.08);
        }
        .theme-light {
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1f2937;
            --text-strong: #111827;
            --muted: #6b7280;
            --brand-1: #4f46e5;
            --brand-2: #7c3aed;
            --filter-bg: #eef2ff; /* light indigo */
            --filter-border: rgba(79,70,229,0.25);
            --label-hover: rgba(79,70,229,0.12);
            --card: #ffffff;
            --card-border: rgba(17,24,39,0.08);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            min-height: 100vh;
            padding: 24px;
            color: var(--text);
        }

        .container {
            max-width: 1800px;  /* Augment√© de 1320px √† 1800px */
            margin: 0 auto;
            background: var(--surface);
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.45);
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .topbar {
            position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(15,23,42,0.8); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.06);
            padding: 10px 16px;
        }
        .brand { font-weight: 800; letter-spacing: .2px; color: #f8fafc; }
        .topbar-sub { color: #cbd5e1; font-weight: 600; }
        .topbar-left { display: flex; align-items: center; gap: 12px; }
        .topbar-divider { width: 1px; height: 18px; background: rgba(255,255,255,0.12); }
        .topbar-right { display: flex; align-items: center; gap: 12px; }

        .pill-cta { padding: 8px 14px; border-radius: 999px; border: none; cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #7c3aed 100%); color: #fff; font-weight: 700;}
        .pill-cta:hover { filter: brightness(1.07); }

        .theme-toggle { display: inline-flex; align-items: center; gap: 8px; cursor: pointer; }
        .theme-toggle .label { color: #cbd5e1; font-size: 12px; }
        .theme-toggle input { display: none; }
        .theme-toggle .slider { width: 42px; height: 22px; background: #1f2937; border-radius: 999px; position: relative; transition: .2s;}
        .theme-toggle .slider::after { content: ''; width: 18px; height: 18px; background: #fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: .2s; }
        .theme-toggle input:checked + .slider { background: #7c3aed; }
        .theme-toggle input:checked + .slider::after { left: 22px; }

        .header {
            background: linear-gradient(180deg, rgba(31,41,55,0.8), rgba(17,24,39,0.8));
            backdrop-filter: blur(8px);
            color: #f8fafc;
            padding: 26px 32px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .tabs {
            display: flex;
            background: rgba(255,255,255,0.2);
            padding: 0;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
        }
        /* Tab visibility control */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab:hover {
            background: rgba(255,255,255,0.1);
        }

        .tab.active {
            background: white;
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        #map {
            height: 800px;  /* Augment√© de 600px √† 800px */
            border-radius: 14px;
            margin: 20px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        /* Dark-themed controls */
        .leaflet-control-zoom a { background: #1f2937; color: #fff; }
        .leaflet-control-zoom a:hover { background: #111827; }
        .leaflet-bar a, .leaflet-bar a:hover { border-color: transparent; }
        /* Cluster colors */
        .marker-cluster-small { background-color: rgba(102, 126, 234, 0.6); }
        .marker-cluster-small div { background-color: rgba(102, 126, 234, 0.9); color:#fff; }
        .marker-cluster-medium { background-color: rgba(118, 75, 162, 0.6); }
        .marker-cluster-medium div { background-color: rgba(118, 75, 162, 0.9); color:#fff; }
        .marker-cluster-large { background-color: rgba(55, 65, 81, 0.6); }
        .marker-cluster-large div { background-color: rgba(31, 41, 55, 0.9); color:#fff; }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 15px 25px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .filters {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
            font-size: 1.3em;  /* Encore plus grand de 0.9em √† 1.1em */
        }

        .filter-group input,
        .filter-group select {
            padding: 12px;  /* Augment√© de 10px √† 12px */
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;  /* Augment√© de 14px √† 16px */
            transition: all 0.3s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .reset-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            align-self: flex-end;
        }

        .reset-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .jobs-container {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .job-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .job-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .job-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .job-id {
            color: #667eea;
            font-weight: 600;
            font-size: 0.9em;
        }

        .job-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tag {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .tag-location {
            background: #e3f2fd;
            color: #1976d2;
        }

        .tag-contract {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .tag-experience {
            background: #fff3e0;
            color: #f57c00;
        }

        .tag-family {
            background: #e8f5e9;
            color: #388e3c;
        }

        .job-company {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .job-description {
            color: #555;
            line-height: 1.6;
            max-height: 100px;
            overflow: hidden;
            position: relative;
            margin-bottom: 10px;
        }

        .job-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .job-date {
            color: #999;
            font-size: 0.85em;
        }

        .job-link {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .job-link:hover {
            background: #5568d3;
            transform: translateX(5px);
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .no-results h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #667eea;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Scrollbar styling */
        .jobs-container::-webkit-scrollbar {
            width: 10px;
        }

        .jobs-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .jobs-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .jobs-container::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .stats {
                gap: 15px;
            }

            .stat-item {
                padding: 10px 15px;
            }

            .filter-row {
                grid-template-columns: 1fr;
            }

            .job-header {
                flex-direction: column;
            }

            .job-footer {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }

        /* Support button + modal */
        .support-fab {
            position: fixed;
            right: 24px;
            bottom: 24px;
            background: #667eea;
            color: #fff;
            border: none;
            border-radius: 24px;
            padding: 12px 16px;
            font-weight: 700;
            box-shadow: 0 10px 30px rgba(102,126,234,0.4);
            cursor: pointer;
            z-index: 9999;
        }
        .support-fab:hover { background: #5568d3; }

        .modal-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4);
            display: none; z-index: 9998;
        }
        .modal {
            position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%);
            width: min(560px, 92vw);
            background: #fff; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: none; z-index: 9999; overflow: hidden;
        }
        .modal-header { padding: 16px 20px; font-weight: 700; background: #f6f7fb; }
        .modal-body { padding: 16px 20px; }
        .modal-footer { padding: 12px 20px; display: flex; justify-content: flex-end; gap: 10px; background: #fafbfe; }
        .modal .row { display: grid; grid-template-columns: 1fr 3fr; gap: 10px; align-items: center; margin-bottom: 12px; }
        .modal input[type="text"], .modal textarea, .modal select { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .modal textarea { min-height: 120px; resize: vertical; }
        .btn { padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; }
        .btn-secondary { background: #e8ebf8; color: #3a3f5c; }
        .btn-primary { background: #667eea; color: #fff; }
        .btn-primary:hover { background: #5568d3; }
        /* ---- Dark theme overrides (pro) ---- */
        .stats { color: var(--text); }
        .stat-item { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.06); }
        .stat-number { color: var(--text-strong); }
        .stat-label { color: var(--muted); }

        .filters { background: var(--bg); border-bottom: 1px solid rgba(255,255,255,0.06); }
        .filter-group label { color: var(--muted); font-weight: 700; letter-spacing: .2px; }
        .filter-group input, .filter-group select { background: var(--bg); color: var(--text); border: 1px solid rgba(255,255,255,0.12); }
        .filter-group input::placeholder { color: #9ca3af; }
        /* Checkbox list (compact dark-blue via CSS vars) */
        #countryFilter, #cityFilter, #contractFilter, #experienceFilter, #familyFilter, #companyFilter, #educationFilter {
            background: var(--filter-bg);
            border: 1px solid var(--filter-border);
            border-radius: 10px;
            padding: 4px; /* extra tight container */
        }
        #countryFilter label, #cityFilter label, #contractFilter label, #experienceFilter label, #familyFilter label, #companyFilter label, #educationFilter label {
            display: block;
            color: #111827; /* black-ish for readability in both themes */
            margin-bottom: 1px; /* extra tight spacing */
            padding: 1px 6px; /* extra tight padding */
            border-radius: 4px;
            background: rgba(255,255,255,0.85);
            font-size: 12px; /* compact */
            line-height: 1.15;
        }
        .theme-light #countryFilter label, .theme-light #cityFilter label, .theme-light #contractFilter label, .theme-light #experienceFilter label, .theme-light #familyFilter label, .theme-light #companyFilter label, .theme-light #educationFilter label {
            background: rgba(255,255,255,0.9);
        }
        #countryFilter label:hover, #cityFilter label:hover, #contractFilter label:hover, #experienceFilter label:hover, #familyFilter label:hover, #companyFilter label:hover, #educationFilter label:hover {
            background: var(--label-hover);
        }
        #countryFilter input[type=checkbox], #cityFilter input[type=checkbox], #contractFilter input[type=checkbox], #experienceFilter input[type=checkbox], #familyFilter input[type=checkbox], #companyFilter input[type=checkbox], #educationFilter input[type=checkbox] {
            accent-color: var(--brand-2);
            margin-right: 8px;
        }
        /* Checked visual state for label text */
        #countryFilter input[type=checkbox]:checked + .cb-text,
        #cityFilter input[type=checkbox]:checked + .cb-text,
        #contractFilter input[type=checkbox]:checked + .cb-text,
        #experienceFilter input[type=checkbox]:checked + .cb-text,
        #familyFilter input[type=checkbox]:checked + .cb-text,
        #companyFilter input[type=checkbox]:checked + .cb-text,
        #educationFilter input[type=checkbox]:checked + .cb-text {
            color: #ffffff;
            background: linear-gradient(135deg, rgba(59,130,246,0.22), rgba(124,58,237,0.22));
            border-radius: 4px;
            padding: 2px 4px;
        }
        .reset-btn { background: linear-gradient(135deg, #667eea 0%, #7c3aed 100%); color: #fff; border: none; }
        .reset-btn:hover { filter: brightness(1.05); }

        .jobs-container { background: transparent; }
        .job-card { background: var(--card); border: 1px solid var(--card-border); box-shadow: 0 8px 24px rgba(0,0,0,0.10); padding: 14px; }
        .job-card:hover { border-color: var(--brand-1); box-shadow: 0 14px 30px rgba(102,126,234,0.20); }
        .job-title { color: var(--text-strong); }
        /* tighter list spacing */
        .job-card { margin-bottom: 10px; }
        .job-description { max-height: 72px; overflow: hidden; }
        .job-id { color: var(--brand-1); }
        .job-company { color: var(--muted); }
        .job-description { color: var(--text); }
        .job-footer { border-top: 1px solid var(--card-border); }
        .job-link { background: linear-gradient(135deg, #667eea 0%, #7c3aed 100%); color: #fff; border: none; }
        .job-link:hover { filter: brightness(1.08); transform: translateX(6px); }

        .tag { border: 1px solid rgba(255,255,255,0.1); }
        .tag-location { background: rgba(59,130,246,0.12); color: #93c5fd; border-color: rgba(59,130,246,0.35); }
        .tag-contract { background: rgba(236,72,153,0.12); color: #f0abfc; border-color: rgba(236,72,153,0.35); }
        .tag-experience { background: rgba(245,158,11,0.12); color: #facc15; border-color: rgba(245,158,11,0.35); }
        .tag-family { background: rgba(34,197,94,0.12); color: #86efac; border-color: rgba(34,197,94,0.35); }

        /* Modal dark */
        .modal { background: #0f172a; border: 1px solid rgba(255,255,255,0.06); }
        .modal-header { background: rgba(255,255,255,0.04); color: #e5e7eb; }
        .modal-body { color: #e5e7eb; }
        .modal textarea, .modal input[type="text"], .modal select { background: #0b1220; color: #e5e7eb; border: 1px solid rgba(255,255,255,0.12); }
        .modal-footer { background: rgba(255,255,255,0.04); }
        .btn-secondary { background: rgba(255,255,255,0.08); color: #e5e7eb; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #7c3aed 100%); color: #fff; }

        /* Support floating button */
        .support-fab { background: linear-gradient(135deg, #667eea 0%, #7c3aed 100%); color: #fff; box-shadow: 0 14px 30px rgba(102,126,234,0.35); }
        .support-fab:hover { filter: brightness(1.07); }
    
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">üíº Job Tracker Finance</div>
            <nav>
                <a href="index.html">üè† Accueil</a>
                <a href="offres.html">üìã Liste des offres</a>
                <a href="carte.html">üó∫Ô∏è Vue g√©ographique</a>
                <a href="filtres.html">‚ö° Recherche avanc√©e</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- Topbar sticky -->
        <div class="topbar">
            <div class="topbar-left">
                <div class="brand">Jobs Dashboard</div>
                <div class="topbar-divider"></div>
                <div class="topbar-sub">Multi‚Äëbanques</div>
            </div>
            <div class="topbar-right">
                <label class="theme-toggle">
                    <input type="checkbox" id="themeSwitch">
                    <span class="slider"></span>
                    <span class="label">Mode sombre</span>
                </label>
            </div>
        </div>
        <div class="header">
            <!-- Title removed for cleaner header -->
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalJobs">-</div>
                    <div class="stat-label">Offres totales</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="filteredJobs">-</div>
                    <div class="stat-label">Affich√©es</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="countries">-</div>
                    <div class="stat-label">Pays</div>
                </div>
            </div>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('list')">üìã Liste des offres</button>
                <button class="tab" onclick="switchTab('map')">üó∫Ô∏è Carte mondiale</button>
                <button class="tab" onclick="switchTab('filters')">üéõÔ∏è Filtres</button>
            </div>
        </div>

        <div class="tab-content active" id="listTab">
        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="searchInput">üîç Recherche (titre, description)</label>
                    <input type="text" id="searchInput" placeholder="Rechercher...">
                </div>
                <div class="filter-group">
                    <label>üåç Pays</label>
                    <div id="countryFilter" style="max-height: 150px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; background: white;">
                    </div>
                </div>
                <div class="filter-group">
                    <label>üèôÔ∏è Ville</label>
                    <div id="cityFilter" style="max-height: 150px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; background: white;">
                    </div>
                </div>
                <div class="filter-group">
                    <label>üìù Type de contrat</label>
                    <div id="contractFilter" style="max-height: 150px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; background: white;">
                    </div>
                </div>
                <div class="filter-group">
                    <label>üíº Exp√©rience</label>
                    <div id="experienceFilter" style="max-height: 150px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; background: white;">
                    </div>
                </div>
            </div>
            <div class="filter-row">
                <div class="filter-group">
                    <label>üéØ Famille de m√©tier</label>
                    <div id="familyFilter" style="max-height: 150px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; background: white;">
                    </div>
                </div>
                <div class="filter-group">
                    <label>üè¢ Entreprise</label>
                    <div id="companyFilter" style="max-height: 150px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; background: white;">
                    </div>
                </div>
                <div class="filter-group">
                    <label>üéì Niveau d'√©tude</label>
                    <div id="educationFilter" style="max-height: 150px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; background: white;">
                    </div>
                </div>
                <div class="filter-group">
                    <button class="reset-btn" onclick="resetFilters()">üîÑ R√©initialiser</button>
                </div>
            </div>
        </div>

        <div class="jobs-container" id="jobsContainer">
            <div class="loading">Chargement des offres</div>
        </div>
        </div>

        <div class="tab-content" id="mapTab">
            <div style="padding: 20px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0;">
                <div style="display: flex; justify-content: center; gap: 20px; align-items: center;">
                    <span style="font-weight: 600;">Vue:</span>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="mapView" value="city" checked onchange="updateMapView()"> Par ville
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="mapView" value="country" onchange="updateMapView()"> Par pays
                    </label>
                </div>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <!-- Filters Composer Tab -->
    <div class="tab-content" id="filtersTab">
        <div class="filters-composer" style="padding:20px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <div style="font-weight:800;color:var(--text-strong)">Compositions de filtres</div>
                <button class="pill-cta" onclick="createNewBrick()">+ Nouveau</button>
            </div>
            <div id="bricksContainer" class="bricks" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px"></div>
        </div>
    </div>

    <!-- Support Floating Button -->
    <button class="support-fab" onclick="openSupportModal()">üí¨ Support</button>

    <!-- Modal -->
    <div id="modalBackdrop" class="modal-backdrop" onclick="closeSupportModal()"></div>
    <div id="supportModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="supportTitle">
        <div class="modal-header" id="supportTitle">Contact support</div>
        <div class="modal-body">
            <div class="row">
                <label for="supportType">Type</label>
                <select id="supportType">
                    <option value="Bug">Signaler un bug</option>
                    <option value="Feature">Sugg√©rer une fonctionnalit√©</option>
                    <option value="Question">Question</option>
                </select>
            </div>
            <div class="row">
                <label for="supportEmail">Votre email</label>
                <input type="text" id="supportEmail" placeholder="votre@email.com">
            </div>
            <div class="row">
                <label for="supportSubject">Sujet</label>
                <input type="text" id="supportSubject" placeholder="Sujet de votre message">
            </div>
            <div class="row">
                <label for="supportMessage">Message</label>
                <textarea id="supportMessage" placeholder="D√©crivez votre besoin/probl√®me..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeSupportModal()">Annuler</button>
            <button class="btn btn-primary" onclick="sendSupportEmail()">Envoyer</button>
        </div>
    </div>

    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>

        let allJobs = [];
        let filteredJobs = [];
        let map = null;
        let markers = [];

        // Charger les donn√©es CSV
        async function loadJobs() {
            try {
                const response = await fetch('scraped_jobs.csv');
                const text = await response.text();
                
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                allJobs = [];
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    // Parser CSV en g√©rant les guillemets
                    const values = parseCSVLine(lines[i]);
                    const job = {};
                    headers.forEach((header, index) => {
                        job[header] = values[index] || '';
                    });
                    allJobs.push(job);
                }
                
                console.log(`Charg√© ${allJobs.length} offres`);
                initializeFilters();
                filteredJobs = [...allJobs];
                renderJobs();
                updateStats();
                updateFilterAvailability();
                
            } catch (error) {
                console.error('Erreur de chargement:', error);
                document.getElementById('jobsContainer').innerHTML = 
                    '<div class="no-results"><h3>‚ùå Erreur de chargement</h3><p>Impossible de charger les offres. Assurez-vous que le fichier CSV est dans le m√™me dossier.</p></div>';
            }
        }

        // Parser une ligne CSV en g√©rant les guillemets et virgules
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }

        // Initialiser les filtres avec les valeurs uniques
        function initializeFilters() {
            const cities = new Set();
            const countries = new Set();
            const contracts = new Set();
            const experiences = new Set();
            const families = new Set();
            const companies = new Set();
            const educations = new Set();
            
            allJobs.forEach(job => {
                if (job.location && job.location.includes(' - ')) {
                    const parts = job.location.split(' - ');
                    cities.add(parts[0]);
                    countries.add(parts[1]);
                }
                if (job.contract_type) contracts.add(job.contract_type);
                if (job.experience_level) experiences.add(job.experience_level);
                if (job.job_family) families.add(job.job_family);
                if (job.company_name) companies.add(job.company_name);
                if (job.education_level) educations.add(job.education_level);
            });
            
            populateSelect('cityFilter', Array.from(cities).sort());
            populateSelect('countryFilter', Array.from(countries).sort());
            populateSelect('contractFilter', Array.from(contracts).sort());
            populateSelect('experienceFilter', Array.from(experiences).sort());
            populateSelect('familyFilter', Array.from(families).sort());
            populateSelect('companyFilter', Array.from(companies).sort());
            populateSelect('educationFilter', Array.from(educations).sort());
            
            // Ajouter les listeners
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            // Les checkboxes ont d√©j√† leurs listeners via onchange
        }

        function populateSelect(id, values) {
            const container = document.getElementById(id);
            
            // Tous deviennent des checkboxes maintenant
            if (false && container.tagName === 'SELECT') {
                // D√©finir l'ordre logique pour certains filtres
                const contractOrder = ['Stage', 'Alternance / Apprentissage', 'VIE', 'CDD', 'CDI', 'Freelance', 'Int√©rim'];
                const educationOrder = [
                    'Inf√©rieur √† Bac',
                    'Bac',
                    'Bac + 2 / L2',
                    'Bac + 3 / L3',
                    'Bac + 4 / M1',
                    'Bac + 5 / M2 et plus'
                ];
                const experienceOrder = ['0 - 2 ans', '3 - 5 ans', '6 - 10 ans', '11 ans et plus'];
                
                // Trier selon le contexte
                let sortedValues = values;
                if (id === 'contractFilter') {
                    sortedValues = values.sort((a, b) => {
                        const indexA = contractOrder.indexOf(a);
                        const indexB = contractOrder.indexOf(b);
                        if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                        if (indexA === -1) return 1;
                        if (indexB === -1) return -1;
                        return indexA - indexB;
                    });
                } else if (id === 'educationFilter') {
                    sortedValues = values.sort((a, b) => {
                        const indexA = educationOrder.indexOf(a);
                        const indexB = educationOrder.indexOf(b);
                        if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                        if (indexA === -1) return 1;
                        if (indexB === -1) return -1;
                        return indexA - indexB;
                    });
                } else if (id === 'experienceFilter') {
                    sortedValues = values.sort((a, b) => {
                        const indexA = experienceOrder.indexOf(a);
                        const indexB = experienceOrder.indexOf(b);
                        if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                        if (indexA === -1) return 1;
                        if (indexB === -1) return -1;
                        return indexA - indexB;
                    });
                }
                
                sortedValues.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    container.appendChild(option);
                });
            } else {
                // Pour les checkboxes - trier selon le filtre
                const contractOrder = ['Stage', 'Alternance / Apprentissage', 'VIE', 'CDD', 'CDI', 'Freelance', 'Int√©rim'];
                const educationOrder = [
                    'Inf√©rieur √† Bac',
                    'Bac',
                    'Bac + 2 / L2',
                    'Bac + 3 / L3',
                    'Bac + 4 / M1',
                    'Bac + 5 / M2 et plus'
                ];
                const experienceOrder = ['0 - 2 ans', '3 - 5 ans', '6 - 10 ans', '11 ans et plus'];
                
                let sortedValues = [...values];
                if (id === 'contractFilter') {
                    sortedValues = values.sort((a, b) => {
                        const indexA = contractOrder.indexOf(a);
                        const indexB = contractOrder.indexOf(b);
                        if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                        if (indexA === -1) return 1;
                        if (indexB === -1) return -1;
                        return indexA - indexB;
                    });
                } else if (id === 'educationFilter') {
                    sortedValues = values.sort((a, b) => {
                        const indexA = educationOrder.indexOf(a);
                        const indexB = educationOrder.indexOf(b);
                        if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                        if (indexA === -1) return 1;
                        if (indexB === -1) return -1;
                        return indexA - indexB;
                    });
                } else if (id === 'experienceFilter') {
                    sortedValues = values.sort((a, b) => {
                        const indexA = experienceOrder.indexOf(a);
                        const indexB = experienceOrder.indexOf(b);
                        if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                        if (indexA === -1) return 1;
                        if (indexB === -1) return -1;
                        return indexA - indexB;
                    });
                } else {
                    sortedValues.sort();
                }
                
                sortedValues.forEach(value => {
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    label.style.marginBottom = '5px';
                    label.style.cursor = 'pointer';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = value;
                    checkbox.style.marginRight = '8px';
                    checkbox.onchange = applyFilters;
                    
                    const span = document.createElement('span');
                    span.className = 'cb-text';
                    span.textContent = value;
                    
                    label.appendChild(checkbox);
                    label.appendChild(span);
                    container.appendChild(label);
                });
            }
        }
        
        function updateFilterAvailability() {
            // Obtenir les offres actuellement visibles selon les filtres actifs
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            const cityContainer = document.getElementById('cityFilter');
            const countryContainer = document.getElementById('countryFilter');
            const contractContainer = document.getElementById('contractFilter');
            const experienceContainer = document.getElementById('experienceFilter');
            const familyContainer = document.getElementById('familyFilter');
            const companyContainer = document.getElementById('companyFilter');
            const educationContainer = document.getElementById('educationFilter');
            
            const selectedCities = Array.from(cityContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            const selectedCountries = Array.from(countryContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            const selectedContracts = Array.from(contractContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            const selectedExperiences = Array.from(experienceContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            const selectedFamilies = Array.from(familyContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            const selectedCompanies = Array.from(companyContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            const selectedEducations = Array.from(educationContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            
            // Pour chaque cat√©gorie, calculer quelles valeurs sont disponibles
            const availableValues = {
                countries: new Set(),
                cities: new Set(),
                contracts: new Set(),
                experiences: new Set(),
                families: new Set(),
                companies: new Set(),
                educations: new Set()
            };
            
            allJobs.forEach(job => {
                // Tester si ce job matcherait avec les filtres actuels (en excluant une cat√©gorie √† la fois)
                const matchSearch = !search || 
                    job.job_title.toLowerCase().includes(search) ||
                    job.job_description.toLowerCase().includes(search);
                
                if (!matchSearch) return;
                
                // Parser location
                let jobCity = null, jobCountry = null;
                if (job.location && job.location.includes(' - ')) {
                    const parts = job.location.split(' - ');
                    jobCity = parts[0];
                    jobCountry = parts[1];
                }
                
                // Pour chaque cat√©gorie, v√©rifier si ce job serait visible si on d√©sactivait cette cat√©gorie
                const matchCityOthers = selectedCities.length === 0 || selectedCities.includes(jobCity);
                const matchCountryOthers = selectedCountries.length === 0 || selectedCountries.includes(jobCountry);
                const matchContractOthers = selectedContracts.length === 0 || selectedContracts.includes(job.contract_type);
                const matchExperienceOthers = selectedExperiences.length === 0 || selectedExperiences.includes(job.experience_level);
                const matchFamilyOthers = selectedFamilies.length === 0 || selectedFamilies.includes(job.job_family);
                const matchCompanyOthers = selectedCompanies.length === 0 || selectedCompanies.includes(job.company_name);
                const matchEducationOthers = selectedEducations.length === 0 || selectedEducations.includes(job.education_level);
                
                // Ajouter aux disponibles selon les autres filtres actifs
                if (matchCityOthers && matchContractOthers && matchExperienceOthers && matchFamilyOthers && matchCompanyOthers && matchEducationOthers) {
                    if (jobCountry) availableValues.countries.add(jobCountry);
                }
                if (matchCountryOthers && matchContractOthers && matchExperienceOthers && matchFamilyOthers && matchCompanyOthers && matchEducationOthers) {
                    if (jobCity) availableValues.cities.add(jobCity);
                }
                if (matchCityOthers && matchCountryOthers && matchExperienceOthers && matchFamilyOthers && matchCompanyOthers && matchEducationOthers) {
                    if (job.contract_type) availableValues.contracts.add(job.contract_type);
                }
                if (matchCityOthers && matchCountryOthers && matchContractOthers && matchFamilyOthers && matchCompanyOthers && matchEducationOthers) {
                    if (job.experience_level) availableValues.experiences.add(job.experience_level);
                }
                if (matchCityOthers && matchCountryOthers && matchContractOthers && matchExperienceOthers && matchCompanyOthers && matchEducationOthers) {
                    if (job.job_family) availableValues.families.add(job.job_family);
                }
                if (matchCityOthers && matchCountryOthers && matchContractOthers && matchExperienceOthers && matchFamilyOthers && matchEducationOthers) {
                    if (job.company_name) availableValues.companies.add(job.company_name);
                }
                if (matchCityOthers && matchCountryOthers && matchContractOthers && matchExperienceOthers && matchFamilyOthers && matchCompanyOthers) {
                    if (job.education_level) availableValues.educations.add(job.education_level);
                }
            });
            
            // Appliquer les √©tats disabled/enabled OU masquage
            function updateCheckboxesGray(container, availableSet) {
                // Pour contrats, exp√©rience, √©tudes: GRISER
                container.querySelectorAll('label').forEach(label => {
                    const checkbox = label.querySelector('input');
                    const span = label.querySelector('span');
                    const value = checkbox.value;
                    
                    if (!availableSet.has(value) && !checkbox.checked) {
                        label.style.opacity = '0.4';
                        label.style.cursor = 'not-allowed';
                        checkbox.disabled = true;
                        span.style.textDecoration = 'line-through';
                    } else {
                        label.style.opacity = '1';
                        label.style.cursor = 'pointer';
                        checkbox.disabled = false;
                        span.style.textDecoration = 'none';
                    }
                });
            }
            
            function updateCheckboxesHide(container, availableSet) {
                // Pour pays, villes, entreprises, familles: MASQUER
                container.querySelectorAll('label').forEach(label => {
                    const checkbox = label.querySelector('input');
                    const value = checkbox.value;
                    
                    if (!availableSet.has(value) && !checkbox.checked) {
                        label.style.display = 'none';
                    } else {
                        label.style.display = 'block';
                    }
                });
            }
            
            // Pays, villes, entreprises, familles: masquer
            updateCheckboxesHide(countryContainer, availableValues.countries);
            updateCheckboxesHide(cityContainer, availableValues.cities);
            updateCheckboxesHide(companyContainer, availableValues.companies);
            updateCheckboxesHide(familyContainer, availableValues.families);
            
            // Contrats, exp√©rience, √©tudes: griser
            updateCheckboxesGray(contractContainer, availableValues.contracts);
            updateCheckboxesGray(experienceContainer, availableValues.experiences);
            updateCheckboxesGray(educationContainer, availableValues.educations);
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            // R√©cup√©rer les checkboxes coch√©es
            const cityContainer = document.getElementById('cityFilter');
            const countryContainer = document.getElementById('countryFilter');
            const selectedCities = Array.from(cityContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            const selectedCountries = Array.from(countryContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            
            // R√©cup√©rer toutes les checkboxes coch√©es
            const contractContainer = document.getElementById('contractFilter');
            const experienceContainer = document.getElementById('experienceFilter');
            const familyContainer = document.getElementById('familyFilter');
            const companyContainer = document.getElementById('companyFilter');
            const educationContainer = document.getElementById('educationFilter');
            
            const selectedContracts = Array.from(contractContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            const selectedExperiences = Array.from(experienceContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            const selectedFamilies = Array.from(familyContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            const selectedCompanies = Array.from(companyContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            const selectedEducations = Array.from(educationContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            
            filteredJobs = allJobs.filter(job => {
                const matchSearch = !search || 
                    job.job_title.toLowerCase().includes(search) ||
                    job.job_description.toLowerCase().includes(search);
                
                // Filtrage ville/pays avec multi-s√©lection
                let matchCity = true;
                let matchCountry = true;
                if (job.location && job.location.includes(' - ')) {
                    const parts = job.location.split(' - ');
                    matchCity = selectedCities.length === 0 || selectedCities.includes(parts[0]);
                    matchCountry = selectedCountries.length === 0 || selectedCountries.includes(parts[1]);
                } else if (selectedCities.length > 0 || selectedCountries.length > 0) {
                    // Si pas de location valide et qu'un filtre est actif, exclure
                    return false;
                }
                
                const matchContract = selectedContracts.length === 0 || selectedContracts.includes(job.contract_type);
                const matchExperience = selectedExperiences.length === 0 || selectedExperiences.includes(job.experience_level);
                const matchFamily = selectedFamilies.length === 0 || selectedFamilies.includes(job.job_family);
                const matchCompany = selectedCompanies.length === 0 || selectedCompanies.includes(job.company_name);
                const matchEducation = selectedEducations.length === 0 || selectedEducations.includes(job.education_level);
                
                return matchSearch && matchCity && matchCountry && matchContract && 
                       matchExperience && matchFamily && matchCompany && matchEducation;
            });
            
            renderJobs();
            updateStats();
            updateCityFilter();
            updateFilterAvailability();
            // Ne pas mettre √† jour la carte quand on filtre la liste
        }
        
        function updateCityFilter() {
            const countryContainer = document.getElementById('countryFilter');
            const selectedCountries = Array.from(countryContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            const cityContainer = document.getElementById('cityFilter');
            const currentSelectedCities = Array.from(cityContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            
            // R√©cup√©rer les villes pour les pays s√©lectionn√©s
            const cities = new Set();
            allJobs.forEach(job => {
                if (job.location && job.location.includes(' - ')) {
                    const parts = job.location.split(' - ');
                    if (selectedCountries.length === 0 || selectedCountries.includes(parts[1])) {
                        cities.add(parts[0]);
                    }
                }
            });
            
            // Mettre √† jour les checkboxes des villes
            cityContainer.innerHTML = '';
            Array.from(cities).sort().forEach(city => {
                const label = document.createElement('label');
                label.style.display = 'block';
                label.style.marginBottom = '5px';
                label.style.cursor = 'pointer';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = city;
                checkbox.checked = currentSelectedCities.includes(city);
                checkbox.style.marginRight = '8px';
                checkbox.onchange = applyFilters;
                
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(city));
                cityContainer.appendChild(label);
            });
        }

        function renderJobs() {
            const container = document.getElementById('jobsContainer');
            
            if (filteredJobs.length === 0) {
                container.innerHTML = '<div class="no-results"><h3>üòï Aucune offre trouv√©e</h3><p>Essayez de modifier vos filtres</p></div>';
                return;
            }
            
            container.innerHTML = filteredJobs.map(job => `
                <div class="job-card" onclick="window.open('${job.job_url}', '_blank')">
                    <div class="job-header">
                        <div>
                            <div class="job-title">${job.job_title}</div>
                            <div class="job-id">${job.job_id}</div>
                        </div>
                    </div>
                    <div class="job-tags">
                        ${job.location ? `<span class="tag tag-location">üìç ${job.location}</span>` : ''}
                        ${job.contract_type ? `<span class="tag tag-contract">üìù ${job.contract_type}</span>` : ''}
                        ${job.experience_level ? `<span class="tag tag-experience">üíº ${job.experience_level}</span>` : ''}
                        ${job.job_family ? `<span class="tag tag-family">üéØ ${job.job_family}</span>` : ''}
                    </div>
                    ${job.company_name ? `<div class="job-company">üè¢ ${job.company_name}</div>` : ''}
                    ${job.job_description ? `<div class="job-description">${job.job_description.substring(0, 250)}...</div>` : ''}
                    <div class="job-footer">
                        <div class="job-date">üìÖ ${job.publication_date || 'Date non sp√©cifi√©e'}</div>
                        <a href="${job.job_url}" target="_blank" class="job-link" onclick="event.stopPropagation()">Voir l'offre ‚Üí</a>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            document.getElementById('totalJobs').textContent = allJobs.length;
            document.getElementById('filteredJobs').textContent = filteredJobs.length;
            
            const uniqueCountries = new Set();
            filteredJobs.forEach(job => {
                if (job.location && job.location.includes(' - ')) {
                    const country = job.location.split(' - ')[1];
                    uniqueCountries.add(country);
                }
            });
            document.getElementById('countries').textContent = uniqueCountries.size;
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            
            // D√©cocher toutes les checkboxes
            document.querySelectorAll('.filters input[type="checkbox"]').forEach(cb => cb.checked = false);
            applyFilters();
        }

        // Gestion des onglets
        function switchTab(tab) {
            // Mettre √† jour les boutons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Mettre √† jour le contenu
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'list') {
                document.getElementById('listTab').classList.add('active');
            } else if (tab === 'map') {
                document.getElementById('mapTab').classList.add('active');
                initMap();
            }
        }

        // Coordonn√©es des pays (capitales)
        const countryCoordinates = {
            "France": [46.6034, 1.8883],
            "Malaisie": [4.2105, 101.9758],
            "Luxembourg": [49.6116, 6.1319],
            "Italie": [41.8719, 12.5674],
            "√âtats-Unis": [37.0902, -95.7129],
            "Allemagne": [51.1657, 10.4515],
            "Canada": [56.1304, -106.3468],
            "Suisse": [46.8182, 8.2275],
            "Singapour": [1.3521, 103.8198],
            "Portugal": [39.3999, -8.2245],
            "Inde": [20.5937, 78.9629],
            "Pays-Bas": [52.1326, 5.2913],
            "Cor√©e du Sud": [35.9078, 127.7669],
            "Irlande": [53.4129, -8.2439],
            "Japon": [36.2048, 138.2529],
            "Hong-Kong": [22.3193, 114.1694],
            "Royaume-Uni": [55.3781, -3.4360],
            "Taiwan": [23.6978, 120.9605],
            "Chine": [35.8617, 104.1954],
            "Monaco": [43.7384, 7.4246],
            "Belgique": [50.5039, 4.4699],
            "Su√®de": [60.1282, 18.6435],
            "Espagne": [40.4637, -3.7492],
            "R√©publique Tch√®que": [49.8175, 15.4730],
        };

        // Coordonn√©es des villes principales
        const cityCoordinates = {
            // France
            "Paris": [48.8566, 2.3522],
            "Montrouge": [48.8176, 2.3200],
            "Lyon": [45.7640, 4.8357],
            "Toulouse": [43.6047, 1.4442],
            "Marseille": [43.2965, 5.3698],
            "Nantes": [47.2184, -1.5536],
            "Villejuif": [48.7889, 2.3631],
            "Massy": [48.7308, 2.2739],
            "Guyancourt": [48.7717, 2.0747],
            "La D√©fense": [48.8920, 2.2380],
            "Saint-Quentin-En-Yvelines": [48.7817, 2.0348],
            "Roubaix": [50.6892, 3.1817],
            "Reims": [49.2583, 4.0317],
            "Montpellier": [43.6108, 3.8767],
            // Luxembourg
            "Luxembourg": [49.6116, 6.1319],
            "Esch-Sur-Alzette": [49.4958, 5.9806],
            // Allemagne
            "M√ºnchen": [48.1351, 11.5820],
            "Frankfurt": [50.1109, 8.6821],
            "Aschheim": [48.1731, 11.7144],
            "Kronberg": [50.1831, 8.5131],
            // Italie
            "Milan": [45.4642, 9.1900],
            "Parma": [44.8015, 10.3279],
            "Roma": [41.9028, 12.4964],
            "Cuneo": [44.3841, 7.5426],
            // Suisse
            "Geneve": [46.2044, 6.1432],
            "Lausanne": [46.5197, 6.6323],
            "Zurich": [47.3769, 8.5417],
            // √âtats-Unis
            "New York": [40.7128, -74.0060],
            "Chicago": [41.8781, -87.6298],
            "Houston": [29.7604, -95.3698],
            // Canada
            "Montreal": [45.5017, -73.5673],
            // Asie
            "Singapour": [1.3521, 103.8198],
            "Putrajaya": [2.9264, 101.6964],
            "Tokyo": [35.6762, 139.6503],
            "Hong Kong": [22.3193, 114.1694],
            "Mumbai": [19.0760, 72.8777],
            "Beijing": [39.9042, 116.4074],
            "Seoul": [37.5665, 126.9780],
            // Europe
            "Lisbon": [38.7223, -9.1393],
            "Dublin": [53.3498, -6.2603],
            "Brussels": [50.8503, 4.3517],
            "Stockholm": [59.3293, 18.0686],
            "Prague": [50.0755, 14.4378],
            "Amsterdam": [52.3676, 4.9041],
            "London": [51.5074, -0.1278],
        };

        function initMap() {
            if (map) { map.remove(); }

            // Modern basemap (Carto Dark Matter)
            map = L.map('map', { zoomControl: true }).setView([28, 8], 2);

            const cartoDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            updateMapView();
        }

        function updateMapView() {
            if (!map) return;
            
            // Nettoyer les marqueurs existants
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            // Affichage par ville uniquement (pas de s√©lecteur ville/pays)
            const cluster = L.markerClusterGroup();
            
            // Compter les offres par ville
            const cityCounts = {};
            allJobs.forEach(job => {
                if (job.location && job.location.includes(' - ')) {
                    const city = job.location.split(' - ')[0];
                    cityCounts[city] = (cityCounts[city] || 0) + 1;
                }
            });
            
            // Cr√©er les marqueurs
            Object.entries(cityCounts).forEach(([city, count]) => {
                const coords = cityCoordinates[city];
                if (coords) {
                    const marker = L.marker(coords, {
                        title: `${city} (${count})`
                    });
                    marker.bindPopup(`
                        <div style="min-width:180px">
                            <div style="font-weight:800;margin-bottom:4px">${city}</div>
                            <div style="opacity:.8">${count} offre${count > 1 ? 's' : ''}</div>
                        </div>
                    `);
                    cluster.addLayer(marker);
                    markers.push(marker);
                }
            });
            map.addLayer(cluster);
        }

        // Support modal & email
        function openSupportModal() {
            document.getElementById('modalBackdrop').style.display = 'block';
            document.getElementById('supportModal').style.display = 'block';
        }
        function closeSupportModal() {
            document.getElementById('modalBackdrop').style.display = 'none';
            document.getElementById('supportModal').style.display = 'none';
        }
        async function sendSupportEmail() {
            const type = document.getElementById('supportType').value;
            const email = document.getElementById('supportEmail').value.trim();
            const subject = document.getElementById('supportSubject').value.trim() || `[${type}] Nouveau message`;
            const message = document.getElementById('supportMessage').value.trim();

            if (!message) {
                alert('Veuillez saisir un message.');
                return;
            }

            try {
                const resp = await fetch('http://localhost:5055/support', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, email, subject, message })
                });
                const data = await resp.json();
                if (resp.ok) {
                    alert('Votre message a √©t√© envoy√© au support. Merci!');
                    closeSupportModal();
                } else {
                    alert('Envoi via service indisponible, ouverture du client email...');
                    // Fallback mailto
                    const target = 'thibault.giraudet@outlook.com';
                    const body = encodeURIComponent(
                        `Type: ${type}\n` +
                        (email ? `Email: ${email}\n` : '') +
                        `\n${message}`
                    );
                    const subj = encodeURIComponent(subject);
                    const mailto = `mailto:${target}?subject=${subj}&body=${body}`;
                    window.location.href = mailto;
                    closeSupportModal();
                }
            } catch (e) {
                alert('Service support indisponible, ouverture du client email...');
                const target = 'thibault.giraudet@outlook.com';
                const body = encodeURIComponent(
                    `Type: ${type}\n` +
                    (email ? `Email: ${email}\n` : '') +
                    `\n${message}`
                );
                const subj = encodeURIComponent(subject);
                const mailto = `mailto:${target}?subject=${subj}&body=${body}`;
                window.location.href = mailto;
                closeSupportModal();
            }
        }

        // Charger au d√©marrage
        loadJobs();

        // Theme switcher logic (light/dark)
        const root = document.documentElement;
        const themeSwitch = document.getElementById('themeSwitch');
        const savedTheme = localStorage.getItem('theme') || 'dark';
        if (savedTheme === 'light') root.classList.add('theme-light');
        if (savedTheme === 'light') themeSwitch.checked = true;
        themeSwitch.addEventListener('change', () => {
            if (themeSwitch.checked) {
                root.classList.add('theme-light');
                localStorage.setItem('theme', 'light');
            } else {
                root.classList.remove('theme-light');
                localStorage.setItem('theme', 'dark');
            }
        });

        // --- Filters Composer (Bricks) ---
        let filterBricks = [];
        const BRICKS_KEY = 'filterBricks';

        function switchTab(tab) {
            // generic tab switcher supporting list/map/filters
            const listTab = document.getElementById('listTab');
            const mapTab = document.getElementById('mapTab');
            const filtersTab = document.getElementById('filtersTab');
            [listTab, mapTab, filtersTab].forEach(el => { if (el) el.classList.remove('active'); });
            if (tab === 'list' && listTab) listTab.classList.add('active');
            if (tab === 'map' && mapTab) { mapTab.classList.add('active'); initMap(); }
            if (tab === 'filters' && filtersTab) { filtersTab.classList.add('active'); renderBricks(); }
        }

        function saveBricks() {
            localStorage.setItem(BRICKS_KEY, JSON.stringify(filterBricks));
        }
        function loadBricks() {
            try {
                const raw = localStorage.getItem(BRICKS_KEY);
                filterBricks = raw ? JSON.parse(raw) : [];
            } catch { filterBricks = []; }
        }

        function getSelectedValues(containerId) {
            const cont = document.getElementById(containerId);
            if (!cont) return [];
            const vals = [];
            cont.querySelectorAll('label').forEach(l => {
                const cb = l.querySelector('input[type="checkbox"]');
                const txt = l.querySelector('.cb-text');
                if (cb && cb.checked && txt) vals.push(txt.textContent);
            });
            return vals;
        }
        function setSelectedValues(containerId, values) {
            const cont = document.getElementById(containerId);
            if (!cont) return;
            // uncheck all first
            cont.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            cont.querySelectorAll('label').forEach(l => {
                const cb = l.querySelector('input[type="checkbox"]');
                const txt = l.querySelector('.cb-text');
                if (cb && txt && values.includes(txt.textContent)) cb.checked = true;
            });
        }
        function applyBrickToList(brick) {
            // copy brick filters into main UI and apply
            setSelectedValues('countryFilter', brick.filters.countries || []);
            updateCityFilter(); // refresh cities according to countries
            setSelectedValues('cityFilter', brick.filters.cities || []);
            setSelectedValues('contractFilter', brick.filters.contracts || []);
            setSelectedValues('experienceFilter', brick.filters.experiences || []);
            setSelectedValues('familyFilter', brick.filters.families || []);
            setSelectedValues('companyFilter', brick.filters.companies || []);
            setSelectedValues('educationFilter', brick.filters.educations || []);
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.value = brick.filters.search || '';
            applyFilters();
        }

        function createNewBrick() {
            // capture current filters
            const brick = {
                id: Date.now(),
                name: `Brique ${filterBricks.length + 1}`,
                filters: {
                    countries: getSelectedValues('countryFilter'),
                    cities: getSelectedValues('cityFilter'),
                    contracts: getSelectedValues('contractFilter'),
                    experiences: getSelectedValues('experienceFilter'),
                    families: getSelectedValues('familyFilter'),
                    companies: getSelectedValues('companyFilter'),
                    educations: getSelectedValues('educationFilter'),
                    search: (document.getElementById('searchInput')?.value || '').trim()
                }
            };
            filterBricks.push(brick);
            saveBricks();
            renderBricks();
        }
        function deleteBrick(id) {
            filterBricks = filterBricks.filter(b => b.id !== id);
            saveBricks();
            renderBricks();
        }
        function updateBrickName(id, newName) {
            const b = filterBricks.find(x => x.id === id);
            if (!b) return;
            b.name = newName.trim() || b.name;
            saveBricks();
            renderBricks();
        }
        function duplicateBrick(id) {
            const b = filterBricks.find(x => x.id === id);
            if (!b) return;
            const nb = JSON.parse(JSON.stringify(b));
            nb.id = Date.now();
            nb.name = b.name + ' (copie)';
            filterBricks.push(nb);
            saveBricks();
            renderBricks();
        }
        function renderBricks() {
            const wrap = document.getElementById('bricksContainer');
            if (!wrap) return;
            wrap.innerHTML = '';
            if (!filterBricks.length) {
                const empty = document.createElement('div');
                empty.style.color = 'var(--muted)';
                empty.textContent = "Aucune brique. Cliquez sur + Nouveau pour cr√©er une composition.";
                wrap.appendChild(empty);
                return;
            }
            filterBricks.forEach(b => {
                const card = document.createElement('div');
                card.style.background = 'var(--surface)';
                card.style.border = '1px solid var(--card-border)';
                card.style.borderRadius = '10px';
                card.style.padding = '12px';
                card.style.display = 'flex';
                card.style.flexDirection = 'column';
                card.style.gap = '8px';

                const header = document.createElement('div');
                header.style.display = 'flex';
                header.style.justifyContent = 'space-between';
                header.style.alignItems = 'center';
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = b.name;
                nameInput.style.background = 'var(--bg)';
                nameInput.style.color = 'var(--text)';
                nameInput.style.border = '1px solid rgba(255,255,255,0.12)';
                nameInput.style.borderRadius = '6px';
                nameInput.style.padding = '6px 8px';
                const saveBtn = document.createElement('button');
                saveBtn.className = 'pill-cta';
                saveBtn.textContent = 'Sauvegarder';
                saveBtn.onclick = () => updateBrickName(b.id, nameInput.value);
                header.appendChild(nameInput);
                header.appendChild(saveBtn);

                const actions = document.createElement('div');
                actions.style.display = 'flex';
                actions.style.gap = '8px';
                const applyBtn = document.createElement('button');
                applyBtn.className = 'pill-cta';
                applyBtn.textContent = 'Appliquer √† la liste';
                applyBtn.onclick = () => { applyBrickToList(b); switchTab('list'); };
                const dupBtn = document.createElement('button');
                dupBtn.className = 'pill-cta';
                dupBtn.textContent = 'Dupliquer';
                dupBtn.onclick = () => duplicateBrick(b.id);
                const delBtn = document.createElement('button');
                delBtn.className = 'pill-cta';
                delBtn.textContent = 'Supprimer';
                delBtn.onclick = () => deleteBrick(b.id);
                actions.appendChild(applyBtn);
                actions.appendChild(dupBtn);
                actions.appendChild(delBtn);

                // small summary
                const summary = document.createElement('div');
                summary.style.color = 'var(--muted)';
                summary.style.fontSize = '12px';
                const counts = [
                    ['Pays', b.filters.countries?.length||0],
                    ['Villes', b.filters.cities?.length||0],
                    ['Contrats', b.filters.contracts?.length||0],
                    ['Exp', b.filters.experiences?.length||0],
                    ['Familles', b.filters.families?.length||0],
                    ['Entrep.', b.filters.companies?.length||0],
                    ['Etudes', b.filters.educations?.length||0],
                ].map(([k,v]) => `${k}:${v}`).join(' ¬∑ ');
                summary.textContent = counts + (b.filters.search ? ` ¬∑ Rech:"${b.filters.search}"` : '');

                card.appendChild(header);
                card.appendChild(actions);
                card.appendChild(summary);
                wrap.appendChild(card);
            });
        }

        loadBricks();

        // Fallback: injection dynamique du bouton si absent (cache navigateur)
        window.addEventListener('load', () => {
            if (!document.querySelector('.support-fab')) {
                const btn = document.createElement('button');
                btn.className = 'support-fab';
                btn.textContent = 'üí¨ Support';
                btn.onclick = openSupportModal;
                document.body.appendChild(btn);
            }
        });
    
    </script>
</body>
</html>