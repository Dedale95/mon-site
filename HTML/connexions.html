<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Connexions - Taleos</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navigation */
        nav {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 30px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a1a1a;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-link {
            text-decoration: none;
            color: #666;
            font-weight: 600;
            font-size: 0.95rem;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
            display: inline-block;
            box-sizing: border-box;
            min-width: fit-content;
            position: relative;
        }

        .nav-link:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .nav-link.active,
        .nav-link-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white !important;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            /* M√™me padding pour √©viter d√©calage */
            padding: 8px 16px;
        }

        .nav-link.active:hover,
        .nav-link-primary:hover {
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            /* Pas de transform pour √©viter d√©calage */
        }

        .logout-btn {
            background: transparent;
            margin-left: 10px;
            color: #666 !important;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95rem;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .logout-btn:hover {
            background: #f3f4f6;
            color: #374151 !important;
            border-color: #d1d5db;
        }

        /* Container principal */
        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
            flex: 1;
        }

        /* Header */
        .page-header {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            text-align: center;
        }

        .page-header h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-header p {
            color: #666;
            font-size: 1.1rem;
        }

        /* Info box */
        .info-box {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .info-box h3 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-box p {
            color: #666;
            line-height: 1.6;
        }

        .info-box ul {
            margin-top: 10px;
            margin-left: 20px;
            color: #666;
            line-height: 1.8;
        }

        /* Modules des banques */
        .banks-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .bank-module {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            transition: all 0.3s;
        }

        .bank-module:hover {
            box-shadow: 0 6px 30px rgba(0, 0, 0, 0.12);
        }

        .bank-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            cursor: pointer;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transition: all 0.3s;
        }

        .bank-header:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }

        .bank-header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .bank-logo {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            object-fit: contain;
            background: white;
            padding: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .bank-info h3 {
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .bank-info p {
            color: #666;
            font-size: 0.9rem;
        }

        .bank-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .bank-status.connected {
            background: #d1fae5;
            color: #065f46;
        }

        .bank-status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        .bank-status.connecting {
            background: #fef3c7;
            color: #92400e;
        }

        .toggle-icon {
            font-size: 1.2rem;
            transition: transform 0.3s;
        }

        .bank-module.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        /* Contenu du module */
        .bank-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s ease;
            opacity: 0;
        }

        .bank-module.expanded .bank-content {
            max-height: 600px;
            opacity: 1;
        }

        .bank-content-inner {
            padding: 30px;
            border-top: 1px solid #e5e7eb;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
        }

        .connection-status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .connection-status.show {
            display: block;
        }

        .connection-status.success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .connection-status.error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .connection-status.info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        /* Spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Footer */
        footer {
            background: #1a1a1a;
            color: white;
            padding: 40px 20px;
            text-align: center;
            margin-top: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-container,
            .nav-links {
                flex-direction: column;
                gap: 15px;
            }

            .bank-header-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .form-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="landing_page_finance.html" class="logo">
                <div class="logo-icon">T</div>
                <div class="logo-text">Taleos</div>
            </a>
            <div class="nav-links">
                <a href="landing_page_finance.html" class="nav-link">Pr√©sentation</a>
                <a href="offres.html" class="nav-link">Offres</a>
                <a href="filtres.html" class="nav-link">Recherche avanc√©e</a>
                <a href="mes-candidatures.html" class="nav-link" id="navCandidatures" style="display: none;">Mes candidatures</a>
                <a href="connexions.html" class="nav-link active" id="navConnexions" style="display: none;">üîó Connexions</a>
                <a href="auth.html" class="nav-link" id="navAuth">Inscription / Connexion</a>
                <a href="profile.html" class="nav-link" id="navProfile" style="display: none;">Mon Profil</a>
                <button class="nav-link logout-btn" id="btnLogout" style="display: none;" onclick="logout()">D√©connexion</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>üîó Mes Connexions</h1>
            <p>Liez vos comptes des sites carri√®re pour une exp√©rience optimis√©e</p>
        </div>

        <div class="info-box">
            <h3>‚ÑπÔ∏è Pourquoi lier vos comptes ?</h3>
            <p>En liant vos comptes des sites carri√®re des banques, vous pourrez :</p>
            <ul>
                <li><strong>Postuler automatiquement</strong> depuis Taleos sans ressaisir vos informations</li>
                <li><strong>Synchroniser vos candidatures</strong> entre les plateformes</li>
                <li><strong>Suivre l'√©tat</strong> de vos candidatures directement depuis votre espace</li>
            </ul>
            <p style="margin-top: 15px;"><strong>üîí S√©curit√© :</strong> Vos identifiants sont crypt√©s et stock√©s de mani√®re s√©curis√©e. Nous ne les utilisons que pour les actions que vous autorisez.</p>
        </div>

        <div class="banks-container" id="banksContainer">
            <!-- Modules g√©n√©r√©s dynamiquement -->
        </div>
    </div>

    <footer>
        <p>&copy; 2026 Taleos. Tous droits r√©serv√©s.</p>
    </footer>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAGeNfIevsaNjfbKTYWMaURhJWdfzWMjmc",
            authDomain: "project-taleos.firebaseapp.com",
            projectId: "project-taleos",
            storageBucket: "project-taleos.firebasestorage.app",
            messagingSenderId: "747525128323",
            appId: "1:747525128323:web:b1c67154edf2b63afb1d78"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Configuration des banques
        const banks = [
            {
                id: 'credit_agricole',
                name: 'Cr√©dit Agricole',
                url: 'https://www.ca-recrute.fr',
                logo: 'images/logos/credit_agricole.png',
                description: 'Site carri√®re du Cr√©dit Agricole'
            },
            {
                id: 'societe_generale',
                name: 'Soci√©t√© G√©n√©rale',
                url: 'https://careers.societegenerale.com',
                logo: 'images/logos/societe_generale.png',
                description: 'Site carri√®re de la Soci√©t√© G√©n√©rale'
            },
            {
                id: 'deloitte',
                name: 'Deloitte',
                url: 'https://jobs2.deloitte.com',
                logo: 'images/logos/deloitte.png',
                description: 'Site carri√®re de Deloitte'
            }
        ];

        let userConnections = {};
        let currentUser = null;

        // Mise √† jour de la navigation
        function updateNavigation(user) {
            const navAuth = document.getElementById('navAuth');
            const navProfile = document.getElementById('navProfile');
            const navCandidatures = document.getElementById('navCandidatures');
            const navConnexions = document.getElementById('navConnexions');
            const btnLogout = document.getElementById('btnLogout');

            if (user && user.emailVerified) {
                navAuth.style.display = 'none';
                navProfile.style.display = 'block';
                navCandidatures.style.display = 'block';
                navConnexions.style.display = 'block';
                btnLogout.style.display = 'block';
            } else {
                navAuth.style.display = 'block';
                navProfile.style.display = 'none';
                navCandidatures.style.display = 'none';
                navConnexions.style.display = 'none';
                btnLogout.style.display = 'none';
            }
        }

        // D√©connexion
        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'landing_page_finance.html';
            }).catch((error) => {
                console.error('Erreur d√©connexion:', error);
            });
        }

        // Fonction pour crypter les donn√©es (simple base64 pour l'exemple, √† am√©liorer)
        function encryptData(data) {
            return btoa(data);
        }

        // Fonction pour d√©crypter les donn√©es
        function decryptData(data) {
            try {
                return atob(data);
            } catch (e) {
                return '';
            }
        }

        // Charger les connexions de l'utilisateur
        async function loadUserConnections() {
            if (!currentUser) return;

            try {
                const docRef = db.collection('profiles').doc(currentUser.uid).collection('career_connections').doc('connections');
                const doc = await docRef.get();
                
                if (doc.exists) {
                    userConnections = doc.data();
                }
            } catch (error) {
                console.error('Erreur chargement connexions:', error);
            }

            renderBanks();
        }

        // Toggle module banque
        function toggleBank(bankId) {
            const module = document.getElementById(`bank-${bankId}`);
            const isExpanded = module.classList.contains('expanded');
            
            // Fermer tous les autres modules
            document.querySelectorAll('.bank-module').forEach(m => {
                m.classList.remove('expanded');
            });

            // Ouvrir celui-ci si il √©tait ferm√©
            if (!isExpanded) {
                module.classList.add('expanded');
            }
        }

        // Tester la connexion √† un site carri√®re
        async function testConnection(bankId, email, password) {
            const bank = banks.find(b => b.id === bankId);
            const statusDiv = document.getElementById(`status-${bankId}`);
            const btn = document.getElementById(`btn-${bankId}`);

            // Afficher le statut de test
            statusDiv.className = 'connection-status show info';
            statusDiv.innerHTML = '‚è≥ Test de la connexion en cours...';
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Test en cours...';

            try {
                // Note: En raison des restrictions CORS, nous ne pouvons pas tester directement
                // la connexion depuis le navigateur. Dans une vraie application, cela n√©cessiterait
                // un backend proxy.
                
                // Simuler un d√©lai de test
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Pour l'instant, on valide juste que les champs sont remplis
                if (email && password && email.includes('@')) {
                    // Sauvegarder les credentials (crypt√©s)
                    await saveConnection(bankId, email, password);
                    
                    statusDiv.className = 'connection-status show success';
                    statusDiv.innerHTML = `‚úÖ Connexion r√©ussie ! Votre compte ${bank.name} est maintenant li√©.<br><small>Note: La validation compl√®te sera effectu√©e lors de votre premi√®re candidature.</small>`;
                    
                    // Mettre √† jour le statut
                    userConnections[bankId] = {
                        email: email,
                        connected: true,
                        connectedAt: new Date().toISOString()
                    };
                    
                    // Re-render pour mettre √† jour le badge
                    setTimeout(() => {
                        renderBanks();
                    }, 2000);
                    
                } else {
                    throw new Error('Email ou mot de passe invalide');
                }

            } catch (error) {
                console.error('Erreur test connexion:', error);
                statusDiv.className = 'connection-status show error';
                statusDiv.innerHTML = `‚ùå √âchec de la connexion : ${error.message}<br><small>V√©rifiez vos identifiants et r√©essayez.</small>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîó Lier mon compte';
            }
        }

        // Sauvegarder une connexion
        async function saveConnection(bankId, email, password) {
            if (!currentUser) return;

            const encryptedPassword = encryptData(password);

            const connectionData = {
                [bankId]: {
                    email: email,
                    password: encryptedPassword,
                    connected: true,
                    connectedAt: firebase.firestore.FieldValue.serverTimestamp()
                }
            };

            await db.collection('profiles').doc(currentUser.uid)
                .collection('career_connections')
                .doc('connections')
                .set(connectionData, { merge: true });
        }

        // Supprimer une connexion
        async function disconnectBank(bankId) {
            if (!currentUser) return;
            
            if (!confirm('√ätes-vous s√ªr de vouloir d√©lier ce compte ?')) {
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Suppression...';

            try {
                await db.collection('profiles').doc(currentUser.uid)
                    .collection('career_connections')
                    .doc('connections')
                    .update({
                        [bankId]: firebase.firestore.FieldValue.delete()
                    });

                delete userConnections[bankId];
                
                const statusDiv = document.getElementById(`status-${bankId}`);
                statusDiv.className = 'connection-status show info';
                statusDiv.innerHTML = '‚úÖ Compte d√©li√© avec succ√®s';

                setTimeout(() => {
                    renderBanks();
                }, 1500);

            } catch (error) {
                console.error('Erreur suppression connexion:', error);
                alert('Erreur lors de la suppression');
                btn.disabled = false;
                btn.innerHTML = '‚úï D√©lier';
            }
        }

        // Render des modules banques
        function renderBanks() {
            const container = document.getElementById('banksContainer');
            
            container.innerHTML = banks.map(bank => {
                const isConnected = userConnections[bank.id]?.connected || false;
                const connectedEmail = userConnections[bank.id]?.email || '';

                return `
                    <div class="bank-module" id="bank-${bank.id}">
                        <div class="bank-header" onclick="toggleBank('${bank.id}')">
                            <div class="bank-header-left">
                                <img src="${bank.logo}" alt="${bank.name}" class="bank-logo" onerror="this.style.display='none'">
                                <div class="bank-info">
                                    <h3>${bank.name}</h3>
                                    <p>${bank.description}</p>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div class="bank-status ${isConnected ? 'connected' : 'disconnected'}">
                                    ${isConnected ? '‚úì Connect√©' : '‚óã Non connect√©'}
                                </div>
                                <span class="toggle-icon">üîΩ</span>
                            </div>
                        </div>
                        <div class="bank-content">
                            <div class="bank-content-inner">
                                ${isConnected ? `
                                    <div style="padding: 20px; background: #d1fae5; border-radius: 8px; margin-bottom: 20px;">
                                        <p style="color: #065f46; font-weight: 600; margin-bottom: 5px;">‚úì Compte li√©</p>
                                        <p style="color: #065f46; font-size: 0.9rem;">Email: ${connectedEmail}</p>
                                    </div>
                                    <div class="form-actions">
                                        <button class="btn btn-danger" onclick="disconnectBank('${bank.id}')">‚úï D√©lier ce compte</button>
                                    </div>
                                ` : `
                                    <p style="color: #666; margin-bottom: 20px;">
                                        Connectez votre compte <strong>${bank.name}</strong> pour postuler automatiquement aux offres.
                                    </p>
                                    <form onsubmit="event.preventDefault(); testConnection('${bank.id}', document.getElementById('email-${bank.id}').value, document.getElementById('password-${bank.id}').value);">
                                        <div class="form-group">
                                            <label for="email-${bank.id}">üìß Email</label>
                                            <input type="email" id="email-${bank.id}" placeholder="votre.email@exemple.com" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="password-${bank.id}">üîí Mot de passe</label>
                                            <input type="password" id="password-${bank.id}" placeholder="Votre mot de passe" required>
                                        </div>
                                        <div class="connection-status" id="status-${bank.id}"></div>
                                        <div class="form-actions">
                                            <button type="submit" class="btn btn-primary" id="btn-${bank.id}">üîó Lier mon compte</button>
                                        </div>
                                    </form>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // V√©rification imm√©diate de l'authentification (avant Firebase)
        (function checkAuthImmediate() {
            const token = localStorage.getItem('authToken');
            const email = localStorage.getItem('userEmail');
            
            if (!token || !email) {
                console.log('‚ùå Page Connexions - Acc√®s refus√©');
                console.log('üîÑ Redirection vers la page de connexion...');
                window.location.href = 'auth.html';
            }
        })();

        // Initialisation
        auth.onAuthStateChanged(async (user) => {
            updateNavigation(user);

            if (user) {
                currentUser = user;
                await loadUserConnections();
                renderBanks();
            } else {
                // V√©rifier localStorage en cas de connexion persistante
                const token = localStorage.getItem('authToken');
                const email = localStorage.getItem('userEmail');
                
                if (token && email) {
                    // Attendre un peu que Firebase charge la session
                    setTimeout(async () => {
                        if (auth.currentUser) {
                            currentUser = auth.currentUser;
                            await loadUserConnections();
                            renderBanks();
                        } else {
                            // Toujours pas d'utilisateur apr√®s attente, rediriger
                            console.log('‚ùå Acc√®s refus√© - Redirection vers la page de connexion');
                            localStorage.removeItem('authToken');
                            localStorage.removeItem('userEmail');
                            window.location.href = 'auth.html';
                        }
                    }, 1500);
                } else {
                    // Aucun token dans localStorage, rediriger imm√©diatement
                    console.log('‚ùå Acc√®s refus√© - Aucune session active');
                    window.location.href = 'auth.html';
                }
            }
        });
    </script>
</body>
</html>
